<!DOCTYPE html>
<html>
<head>
    <title>SAME Iowa Gambling experiment</title>
    <script src="https://unpkg.com/jspsych@7.3.3"></script>
    <script src="iowa-gambling_jsfile.js"></script>
    <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" type="text/css"/>
</head>
<body></body>
<script>
    const experiment_payoff = 1;
    const TRIALS = 24;
    const WIN_CHANCE = .5;
    const START_POINTS = 200;
    let highest_score = 0; // Initialize high_score with a default value

    jsPsych = initJsPsych({
        on_finish: function () {
            jsPsych.data.get().filter({trial_type: 'iowaGambling'}).localSave('csv', 'experiment_data.csv');
        }
    })

    if (Math.random() >= 0.5) {
        highest_score = START_POINTS * 1.5; // Update high_score if the condition is met
    }

    values_array = [[[10, 0], [5, 0], [5, 0], [10, 0]], [[10, -25], [5, -5], [5, -5], [10, -25]], [[25, -200], [5, -5], [5, -5], [25, -200]]]

    let values = values_array[1]
    let flips = []
    // Create a variable win chance that decreases over time
    let winChance = WIN_CHANCE;

    let score = START_POINTS

    timeline = []
    for (let i = 0; i < TRIALS; i++) {
        if (experiment_payoff === 2) { // Apply this logic only for the last payoff scheme
            winChance = 1 - ((i / TRIALS)*0.8); // Decreases linearly over time
        }

        // Determine if this trial is a win or loss based on winChance
        if (Math.random() < winChance) {
            flip = 0; // Win
        } else {
            flip = 1; // Loss
        }
        timeline.push(
            {
                type: jsPsychIowaGambling,
                values: [values[0][flip], values[1][flip], values[2][flip], values[3][flip]],
                reward_penalty: [
                    [values[0][0], values[0][1]],
                    [values[1][0], values[1][1]],
                    [values[2][0], values[2][1]],
                    [values[3][0], values[3][1]]],
                chance: winChance,
                current_score: () => {
                    return score
                },
                high_score: () => {
                    return highest_score
                },
                on_finish: (data) => {
                    score = data.score_after
                    if (data.reward === 5) {
                        data['type'] = 0
                    } else {
                        data['type'] = 1
                    }
                }
            })
    }

    jsPsych.run(timeline);


    function shuffle(array) {
        let currentIndex = array.length, randomIndex;

        // While there remain elements to shuffle.
        while (currentIndex > 0) {

            // Pick a remaining element.
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex--;

            // And swap it with the current element.
            [array[currentIndex], array[randomIndex]] = [
                array[randomIndex], array[currentIndex]];
        }

        return array;
    }

</script>
</html>